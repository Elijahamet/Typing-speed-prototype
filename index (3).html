<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Ultimate Typing Speed Test Pro - World's Most Advanced</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Orbitron:wght@400;700;900&family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-cyan: #00ffff;
            --primary-magenta: #ff00ff;
            --primary-green: #00ff00;
            --primary-orange: #ff8800;
            --primary-blue: #0088ff;
            --primary-purple: #8800ff;
            --primary-red: #ff0040;
            --primary-yellow: #ffff00;
            --bg-dark: #0c0c0c;
            --bg-secondary: #1a0033;
            --bg-tertiary: #2a1a4a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #888;
            --text-tertiary: #666;
            --success: #00ff00;
            --error: #ff0040;
            --warning: #ffaa00;
            --info: #00aaff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(255, 200, 100, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.8; }
            25% { transform: rotate(90deg) scale(1.1); opacity: 1; }
            50% { transform: rotate(180deg) scale(1.2); opacity: 0.9; }
            75% { transform: rotate(270deg) scale(1.1); opacity: 1; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Advanced Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 15px 30px;
            margin-bottom: 25px;
            animation: slideInDown 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .nav-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: navShine 3s infinite;
        }

        @keyframes navShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-magenta), var(--primary-green));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoGlow 2s ease-in-out infinite alternate;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        @keyframes logoGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.3); }
        }

        .nav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-btn, .theme-selector, .sound-toggle, .profile-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px 18px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover, .theme-selector:hover, .sound-toggle:hover, .profile-btn:hover {
            background: rgba(0, 255, 255, 0.15);
            border-color: var(--primary-cyan);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        /* Enhanced Header */
        .header {
            text-align: center;
            margin-bottom: 35px;
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            font-family: 'Orbitron', monospace;
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-magenta), var(--primary-green), var(--primary-orange));
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease-in-out infinite;
            text-shadow: 0 0 40px rgba(0, 255, 255, 0.6);
            margin-bottom: 15px;
            position: relative;
        }

        .header h1::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: titleShine 3s infinite;
            pointer-events: none;
        }

        @keyframes titleShine {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(100%) skewX(-15deg); }
        }

        .subtitle {
            font-size: 1.4rem;
            color: var(--text-secondary);
            font-weight: 300;
            margin-bottom: 10px;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(45deg, var(--primary-purple), var(--primary-blue));
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: pulse 2s infinite;
        }

        /* Advanced Game Mode Selector */
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.2s both;
        }

        .mode-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .mode-card:hover::before {
            transform: translateX(100%);
        }

        .mode-card.active {
            border-color: var(--primary-cyan);
            background: rgba(0, 255, 255, 0.1);
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.3);
        }

        .mode-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.2);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .mode-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-cyan);
            font-size: 1.1rem;
        }

        .mode-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .mode-features {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* Enhanced Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.4s both;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 255, 255, 0.4);
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-cyan);
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
            font-family: 'Orbitron', monospace;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
            opacity: 0.7;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--error); }
        .trend-neutral { color: var(--warning); }

        .timer.warning {
            animation: pulse 1s infinite;
            color: var(--warning);
        }

        .timer.critical {
            animation: shake 0.5s infinite;
            color: var(--error);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Advanced Progress System */
        .progress-section {
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.6s both;
        }

        .progress-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .progress-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--glass-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-cyan), var(--primary-magenta), var(--primary-green));
            background-size: 200% 100%;
            border-radius: 6px;
            transition: width 0.4s ease;
            width: 100%;
            position: relative;
            animation: progressFlow 3s linear infinite;
        }

        @keyframes progressFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .streak-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            min-width: 120px;
        }

        .streak-fire {
            font-size: 2rem;
            animation: flicker 1.5s infinite alternate;
        }

        @keyframes flicker {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); }
        }

        .streak-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .streak-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Enhanced Game Area */
        .game-area {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 35px;
            margin-bottom: 30px;
            position: relative;
            animation: fadeInUp 1s ease-out 0.8s both;
            overflow: hidden;
        }

        .game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
            pointer-events: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .difficulty-indicator {
            background: var(--glass-bg);
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            border: 1px solid var(--glass-border);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }

        .live-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .live-stat-value {
            font-weight: 700;
            color: var(--primary-green);
        }

        .live-stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .typing-prompt {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            font-size: clamp(1.1rem, 2.8vw, 1.6rem);
            line-height: 2;
            border: 1px solid var(--glass-border);
            min-height: 140px;
            display: flex;
            align-items: center;
            position: relative;
            font-family: 'Fira Code', monospace;
        }

        .sentence {
            letter-spacing: 1.5px;
            position: relative;
            word-spacing: 0.3em;
        }

        .sentence span {
            transition: all 0.2s ease;
            position: relative;
            border-radius: 3px;
            padding: 2px 1px;
        }

        .sentence span.correct {
            color: var(--success);
            background: rgba(0, 255, 0, 0.1);
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.6);
            animation: correctPulse 0.3s ease-out;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .sentence span.incorrect {
            color: var(--error);
            background: rgba(255, 0, 64, 0.3);
            text-shadow: 0 0 8px rgba(255, 0, 64, 0.6);
            animation: errorShake 0.4s ease-in-out;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .sentence span.current {
            background: rgba(0, 255, 255, 0.4);
            animation: blink 1.2s infinite;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.4; }
        }

        .typing-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--glass-border);
            border-radius: 18px;
            padding: 25px;
            font-size: 1.3rem;
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
            outline: none;
            transition: all 0.4s ease;
            position: relative;
            letter-spacing: 1px;
        }

        .typing-input:focus {
            border-color: var(--primary-cyan);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.5);
            transform: scale(1.02);
            background: rgba(0, 0, 0, 0.6);
        }

        .typing-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Advanced Keyboard Heatmap */
        .keyboard-heatmap {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
        }

        .keyboard-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-cyan);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .keyboard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .key {
            min-width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .key::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .key:hover::before {
            transform: translateX(100%);
        }

        .key.active {
            background: var(--primary-cyan);
            color: var(--bg-dark);
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            animation: keyPress 0.2s ease-out;
        }

        @keyframes keyPress {
            0% { transform: scale(1.15); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1.15); }
        }

        .key.error {
            background: var(--error);
            animation: keyError 0.6s ease-in-out;
        }

        @keyframes keyError {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2) rotate(-5deg); }
            75% { transform: scale(1.2) rotate(5deg); }
        }

        .key.frequent {
            background: linear-gradient(45deg, var(--primary-green), var(--primary-blue));
            animation: frequentGlow 2s infinite alternate;
        }

        @keyframes frequentGlow {
            0% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.3); }
            100% { box-shadow: 0 0 15px rgba(0, 255, 0, 0.8); }
        }

        .space-key {
            width: 250px !important;
            justify-self: center;
        }

        /* Finger Position Guide */
        .finger-guide {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }

        .finger-guide-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-magenta);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .finger-colors {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .finger-color {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
        }

        .left-pinky { background: #ff6b6b; }
        .left-ring { background: #4ecdc4; }
        .left-middle { background: #45b7d1; }
        .left-index { background: #96ceb4; }
        .thumbs { background: #ffeaa7; }
        .right-index { background: #dda0dd; }
        .right-middle { background: #98d8c8; }
        .right-ring { background: #f7dc6f; }
        .right-pinky { background: #bb8fce; }

        /* Live WPM Graph */
        .live-graph {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
            height: 250px;
        }

        .graph-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-green);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .graph-container {
            width: 100%;
            height: 180px;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .graph-line {
            stroke: var(--primary-cyan);
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.6));
            animation: drawLine 2s ease-in-out;
        }

        @keyframes drawLine {
            0% { stroke-dasharray: 1000; stroke-dashoffset: 1000; }
            100% { stroke-dasharray: 1000; stroke-dashoffset: 0; }
        }

        .graph-grid {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 1;
        }

        .graph-labels {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Enhanced Achievements */
        .achievements-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .achievements-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-cyan);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .achievement-categories {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .category-btn.active {
            background: var(--primary-cyan);
            color: var(--bg-dark);
            border-color: var(--primary-cyan);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
        }

        .achievement {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .achievement::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .achievement:hover::before {
            transform: translateX(100%);
        }

        .achievement.unlocked {
            border-color: var(--primary-green);
            background: rgba(0, 255, 0, 0.1);
            animation: achievementGlow 3s infinite alternate;
            transform: scale(1.05);
        }

        @keyframes achievementGlow {
            0% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.4); }
            100% { box-shadow: 0 0 25px rgba(0, 255, 0, 0.8); }
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            animation: achievementFloat 3s ease-in-out infinite;
        }

        @keyframes achievementFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .achievement-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .achievement-progress {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-cyan), var(--primary-green));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Advanced Sound System */
        .sound-panel {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }

        .sound-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-orange);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sound-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .sound-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .sound-slider {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .sound-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary-cyan);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Typing Lessons */
        .lessons-panel {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }

        .lessons-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-purple);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .lesson-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .lesson-category {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lesson-category:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .lesson-category-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-cyan);
        }

        .lesson-category-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .lesson-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .lesson-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 0 10px;
            overflow: hidden;
        }

        .lesson-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Multiplayer Simulation */
        .multiplayer-panel {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }

        .multiplayer-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-red);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .race-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .racer {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .racer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-magenta));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .racer-info {
            flex: 1;
        }

        .racer-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .racer-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .racer-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-cyan));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .racer-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Enhanced Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .btn {
            background: linear-gradient(45deg, var(--primary-magenta), var(--primary-cyan));
            border: none;
            border-radius: 18px;
            padding: 18px 35px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.4s ease;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 0, 255, 0.5);
        }

        .btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn.secondary {
            background: linear-gradient(45deg, var(--primary-green), var(--primary-orange));
        }

        .btn.secondary:hover {
            box-shadow: 0 15px 35px rgba(0, 255, 0, 0.5);
        }

        .btn.tertiary {
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
        }

        .btn.tertiary:hover {
            box-shadow: 0 15px 35px rgba(0, 136, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Enhanced Game Over Modal */
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.6s ease;
        }

        .game-over.show {
            opacity: 1;
            visibility: visible;
        }

        .game-over-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 50px;
            text-align: center;
            max-width: 700px;
            width: 90%;
            animation: gameOverSlide 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        .game-over-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: modalShine 3s infinite;
            pointer-events: none;
        }

        @keyframes modalShine {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(100%) skewX(-15deg); }
        }

        @keyframes gameOverSlide {
            from {
                transform: translateY(-80px) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .game-over h2 {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, var(--primary-magenta), var(--primary-cyan), var(--primary-green));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }

        .performance-grade {
            font-size: 5rem;
            font-weight: 900;
            margin: 25px 0;
            text-shadow: 0 0 30px currentColor;
            font-family: 'Orbitron', monospace;
            animation: gradeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes gradeGlow {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .grade-s { color: #ffd700; text-shadow: 0 0 30px #ffd700; }
        .grade-a { color: #00ff00; text-shadow: 0 0 30px #00ff00; }
        .grade-b { color: #00ffff; text-shadow: 0 0 30px #00ffff; }
        .grade-c { color: #ffaa00; text-shadow: 0 0 30px #ffaa00; }
        .grade-d { color: #ff0040; text-shadow: 0 0 30px #ff0040; }

        .final-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .final-stat {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .final-stat:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .final-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-cyan);
            margin-bottom: 5px;
        }

        .final-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .performance-analysis {
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
        }

        .analysis-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-green);
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            color: var(--text-secondary);
        }

        .analysis-value {
            font-weight: 600;
            color: var(--primary-cyan);
        }

        /* Advanced Notification System */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            padding: 20px 25px;
            z-index: 1001;
            transform: translateX(450px);
            transition: transform 0.4s ease;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(0, 255, 0, 0.1);
        }

        .notification.error {
            border-color: var(--error);
            background: rgba(255, 0, 64, 0.1);
        }

        .notification.warning {
            border-color: var(--warning);
            background: rgba(255, 170, 0, 0.1);
        }

        .notification.achievement {
            border-color: var(--primary-green);
            background: rgba(0, 255, 0, 0.1);
            animation: achievementPulse 1.5s ease-in-out;
        }

        @keyframes achievementPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .notification-icon {
            font-size: 1.2rem;
        }

        .notification-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .notification-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Advanced Leaderboard */
        .leaderboard {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .leaderboard-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-cyan);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .leaderboard-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .leaderboard-tab {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .leaderboard-tab.active {
            background: var(--primary-cyan);
            color: var(--bg-dark);
            border-color: var(--primary-cyan);
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .leaderboard-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .leaderboard-entry:hover::before {
            left: 100%;
        }

        .leaderboard-entry:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.2);
        }

        .leaderboard-rank {
            font-weight: 700;
            color: var(--primary-cyan);
            min-width: 40px;
            font-size: 1.1rem;
        }

        .leaderboard-info {
            flex: 1;
            margin-left: 20px;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .leaderboard-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .leaderboard-score {
            font-weight: 600;
            color: var(--primary-green);
            font-size: 1.1rem;
        }

        .leaderboard-medal {
            margin-left: 10px;
            font-size: 1.2rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .stats-dashboard {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .nav-bar {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }
            
            .nav-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .game-area {
                padding: 25px;
            }
            
            .typing-prompt {
                padding: 20px;
                font-size: 1.1rem;
            }
            
            .typing-input {
                padding: 20px;
                font-size: 1.1rem;
            }
            
            .stats-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mode-selector {
                grid-template-columns: 1fr;
            }
            
            .final-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-dashboard {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .keyboard-row {
                gap: 3px;
            }
            
            .key {
                min-width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }
            
            .space-key {
                width: 180px !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-magenta));
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--primary-magenta), var(--primary-cyan));
        }

        /* Advanced Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Focus Mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .focus-mode.active {
            display: flex;
        }

        .focus-content {
            max-width: 800px;
            width: 90%;
            text-align: center;
        }

        /* Typing Burst Indicator */
        .burst-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--glass-bg);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .burst-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .burst-indicator.fast {
            background: rgba(0, 255, 0, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .burst-indicator.slow {
            background: rgba(255, 170, 0, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Word Highlighting */
        .word-highlight {
            background: rgba(0, 255, 255, 0.2);
            border-radius: 4px;
            padding: 2px 4px;
            margin: 0 2px;
            transition: all 0.2s ease;
        }

        .word-highlight.completed {
            background: rgba(0, 255, 0, 0.2);
            animation: wordComplete 0.5s ease-out;
        }

        @keyframes wordComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Typing Flow State */
        .flow-indicator {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            width: 6px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .flow-fill {
            width: 100%;
            background: linear-gradient(to top, var(--error), var(--warning), var(--success));
            border-radius: 3px;
            transition: height 0.3s ease;
            height: 0%;
        }

        /* Advanced Theme System */
        .theme-matrix {
            --primary-cyan: #00ff00;
            --primary-magenta: #008800;
            --primary-green: #00ffff;
            --bg-dark: #001100;
            --bg-secondary: #002200;
        }
        
        .theme-neon {
            --primary-cyan: #ff00ff;
            --primary-magenta: #8800ff;
            --primary-green: #ff0088;
            --bg-dark: #110011;
            --bg-secondary: #220022;
        }
        
        .theme-retro {
            --primary-cyan: #ff8800;
            --primary-magenta: #ffaa00;
            --primary-green: #ff6600;
            --bg-dark: #221100;
            --bg-secondary: #332200;
        }

        .theme-ocean {
            --primary-cyan: #00aaff;
            --primary-magenta: #0088cc;
            --primary-green: #00ccff;
            --bg-dark: #001122;
            --bg-secondary: #002244;
        }

        .theme-sunset {
            --primary-cyan: #ff6600;
            --primary-magenta: #ff4400;
            --primary-green: #ff8800;
            --bg-dark: #220011;
            --bg-secondary: #440022;
        }

        /* Accessibility Features */
        .high-contrast {
            filter: contrast(150%);
        }

        .large-text {
            font-size: 1.2em;
        }

        .reduced-motion * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .nav-bar, .control-panel, .achievements-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Advanced Navigation Bar -->
    <div class="nav-bar">
        <div class="logo">⚡ ULTIMATE TYPING PRO MAX</div>
        <div class="nav-controls">
            <select class="theme-selector" id="themeSelector">
                <option value="cyberpunk">🌆 Cyberpunk</option>
                <option value="matrix">🟢 Matrix</option>
                <option value="neon">💜 Neon Dreams</option>
                <option value="retro">🟠 Retro Wave</option>
                <option value="ocean">🌊 Ocean Blue</option>
                <option value="sunset">🌅 Sunset</option>
            </select>
            <button class="sound-toggle" id="soundToggle">🔊 Sound ON</button>
            <button class="nav-btn" id="focusBtn">🎯 Focus Mode</button>
            <button class="nav-btn" id="lessonsBtn">📚 Lessons</button>
            <button class="profile-btn" id="profileBtn">👤 Profile</button>
        </div>
    </div>

    <div class="container">
        <!-- Enhanced Header -->
        <div class="header">
            <h1>🚀 Ultimate Typing Speed Test</h1>
            <div class="subtitle">Master your typing skills with advanced analytics & AI coaching</div>
            <div class="version-badge">v3.0 Pro Max Edition</div>
        </div>

        <!-- Advanced Game Mode Selector -->
        <div class="mode-selector">
            <div class="mode-card active" data-mode="classic">
                <div class="mode-icon">⚡</div>
                <div class="mode-title">Classic Sprint</div>
                <div class="mode-desc">60-second speed test with real-time analytics</div>
                <div class="mode-features">• Live WPM tracking • Error analysis • Sound effects</div>
            </div>
            <div class="mode-card" data-mode="marathon">
                <div class="mode-icon">🏃</div>
                <div class="mode-title">Marathon</div>
                <div class="mode-desc">5-minute endurance challenge</div>
                <div class="mode-features">• Stamina tracking • Consistency analysis • Fatigue detection</div>
            </div>
            <div class="mode-card" data-mode="zen">
                <div class="mode-icon">🧘</div>
                <div class="mode-title">Zen Mode</div>
                <div class="mode-desc">No timer, pure focus meditation</div>
                <div class="mode-features">• Mindful typing • Flow state tracking • Stress relief</div>
            </div>
            <div class="mode-card" data-mode="challenge">
                <div class="mode-icon">🎯</div>
                <div class="mode-title">Daily Challenge</div>
                <div class="mode-desc">Special difficulty with rewards</div>
                <div class="mode-features">• Unique content • Bonus points • Leaderboard ranking</div>
            </div>
            <div class="mode-card" data-mode="race">
                <div class="mode-icon">🏎️</div>
                <div class="mode-title">Speed Race</div>
                <div class="mode-desc">Compete against AI opponents</div>
                <div class="mode-features">• Multiplayer simulation • Racing track • Nitro boosts</div>
            </div>
            <div class="mode-card" data-mode="custom">
                <div class="mode-icon">⚙️</div>
                <div class="mode-title">Custom Text</div>
                <div class="mode-desc">Practice with your own content</div>
                <div class="mode-features">• Import text • PDF support • Code practice</div>
            </div>
        </div>

        <!-- Enhanced Progress Section -->
        <div class="progress-section">
            <div class="progress-container">
                <div class="progress-bars">
                    <div class="progress-label">Time Remaining</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-label">Typing Flow State</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="flowFill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="streak-indicator">
                    <span class="streak-fire">🔥</span>
                    <span class="streak-count" id="streakCount">0</span>
                    <span class="streak-label">Day Streak</span>
                </div>
            </div>
        </div>

        <!-- Enhanced Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <div class="stat-icon">⏱️</div>
                <div class="stat-label">Time</div>
                <div class="stat-value timer" id="timer">60</div>
                <div class="stat-trend" id="timeTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚡</div>
                <div class="stat-label">WPM</div>
                <div class="stat-value" id="wpm">0</div>
                <div class="stat-trend trend-neutral" id="wpmTrend">+0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="accuracy">100%</div>
                <div class="stat-trend trend-up" id="accuracyTrend">Perfect!</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">❌</div>
                <div class="stat-label">Errors</div>
                <div class="stat-value" id="errors">0</div>
                <div class="stat-trend" id="errorTrend">Clean!</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🏆</div>
                <div class="stat-label">Best WPM</div>
                <div class="stat-value" id="bestWpm">0</div>
                <div class="stat-trend" id="bestTrend">New record!</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-label">Avg WPM</div>
                <div class="stat-value" id="avgWpm">0</div>
                <div class="stat-trend" id="avgTrend">Improving</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎵</div>
                <div class="stat-label">Rhythm</div>
                <div class="stat-value" id="rhythm">0</div>
                <div class="stat-trend" id="rhythmTrend">Steady</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🌊</div>
                <div class="stat-label">Flow</div>
                <div class="stat-value" id="flowState">0%</div>
                <div class="stat-trend" id="flowTrend">Building</div>
            </div>
        </div>

        <!-- Enhanced Game Area -->
        <div class="game-area">
            <div class="game-header">
                <div class="difficulty-indicator" id="difficultyIndicator">Medium</div>
                <div class="live-stats">
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveWpm">0</div>
                        <div class="live-stat-label">Live WPM</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value" id="liveAccuracy">100%</div>
                        <div class="live-stat-label">Live Accuracy</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-value" id="wordsTyped">0</div>
                        <div class="live-stat-label">Words</div>
                    </div>
                </div>
            </div>
            
            <div class="burst-indicator" id="burstIndicator">
                <span id="burstText">Speed Burst!</span>
            </div>
            
            <div class="typing-prompt">
                <div class="sentence" id="sentence"></div>
            </div>
            
            <input type="text" class="typing-input" id="typingInput" placeholder="Start typing to begin the ultimate test..." autocomplete="off" spellcheck="false">
        </div>

        <!-- Live WPM Graph -->
        <div class="live-graph">
            <div class="graph-title">📈 Real-Time Performance Graph</div>
            <div class="graph-container" id="graphContainer">
                <svg width="100%" height="100%" viewBox="0 0 500 180">
                    <!-- Grid lines -->
                    <defs>
                        <pattern id="grid" width="50" height="18" patternUnits="userSpaceOnUse">
                            <path d="M 50 0 L 0 0 0 18" fill="none" class="graph-grid"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                    
                    <!-- WPM Line -->
                    <polyline class="graph-line" id="wpmLine" points=""></polyline>
                    
                    <!-- Accuracy Line -->
                    <polyline class="graph-line" id="accuracyLine" points="" style="stroke: var(--primary-green); stroke-width: 2;"></polyline>
                </svg>
                <div class="graph-labels">
                    <span>0s</span>
                    <span>15s</span>
                    <span>30s</span>
                    <span>45s</span>
                    <span>60s</span>
                </div>
            </div>
        </div>

        <!-- Advanced Keyboard Heatmap -->
        <div class="keyboard-heatmap" id="keyboardHeatmap">
            <div class="keyboard-title">⌨️ Live Keyboard Heatmap & Finger Guide</div>
            <div class="keyboard-container">
                <div class="keyboard-row">
                    <div class="key left-pinky" data-key="`" data-finger="left-pinky">`</div>
                    <div class="key left-pinky" data-key="1" data-finger="left-pinky">1</div>
                    <div class="key left-ring" data-key="2" data-finger="left-ring">2</div>
                    <div class="key left-middle" data-key="3" data-finger="left-middle">3</div>
                    <div class="key left-index" data-key="4" data-finger="left-index">4</div>
                    <div class="key left-index" data-key="5" data-finger="left-index">5</div>
                    <div class="key right-index" data-key="6" data-finger="right-index">6</div>
                    <div class="key right-index" data-key="7" data-finger="right-index">7</div>
                    <div class="key right-middle" data-key="8" data-finger="right-middle">8</div>
                    <div class="key right-ring" data-key="9" data-finger="right-ring">9</div>
                    <div class="key right-pinky" data-key="0" data-finger="right-pinky">0</div>
                    <div class="key right-pinky" data-key="-" data-finger="right-pinky">-</div>
                    <div class="key right-pinky" data-key="=" data-finger="right-pinky">=</div>
                </div>
                <div class="keyboard-row">
                    <div class="key left-pinky" data-key="q" data-finger="left-pinky">Q</div>
                    <div class="key left-ring" data-key="w" data-finger="left-ring">W</div>
                    <div class="key left-middle" data-key="e" data-finger="left-middle">E</div>
                    <div class="key left-index" data-key="r" data-finger="left-index">R</div>
                    <div class="key left-index" data-key="t" data-finger="left-index">T</div>
                    <div class="key right-index" data-key="y" data-finger="right-index">Y</div>
                    <div class="key right-index" data-key="u" data-finger="right-index">U</div>
                    <div class="key right-middle" data-key="i" data-finger="right-middle">I</div>
                    <div class="key right-ring" data-key="o" data-finger="right-ring">O</div>
                    <div class="key right-pinky" data-key="p" data-finger="right-pinky">P</div>
                    <div class="key right-pinky" data-key="[" data-finger="right-pinky">[</div>
                    <div class="key right-pinky" data-key="]" data-finger="right-pinky">]</div>
                </div>
                <div class="keyboard-row">
                    <div class="key left-pinky" data-key="a" data-finger="left-pinky">A</div>
                    <div class="key left-ring" data-key="s" data-finger="left-ring">S</div>
                    <div class="key left-middle" data-key="d" data-finger="left-middle">D</div>
                    <div class="key left-index" data-key="f" data-finger="left-index">F</div>
                    <div class="key left-index" data-key="g" data-finger="left-index">G</div>
                    <div class="key right-index" data-key="h" data-finger="right-index">H</div>
                    <div class="key right-index" data-key="j" data-finger="right-index">J</div>
                    <div class="key right-middle" data-key="k" data-finger="right-middle">K</div>
                    <div class="key right-ring" data-key="l" data-finger="right-ring">L</div>
                    <div class="key right-pinky" data-key=";" data-finger="right-pinky">;</div>
                    <div class="key right-pinky" data-key="'" data-finger="right-pinky">'</div>
                </div>
                <div class="keyboard-row">
                    <div class="key left-pinky" data-key="z" data-finger="left-pinky">Z</div>
                    <div class="key left-ring" data-key="x" data-finger="left-ring">X</div>
                    <div class="key left-middle" data-key="c" data-finger="left-middle">C</div>
                    <div class="key left-index" data-key="v" data-finger="left-index">V</div>
                    <div class="key left-index" data-key="b" data-finger="left-index">B</div>
                    <div class="key right-index" data-key="n" data-finger="right-index">N</div>
                    <div class="key right-index" data-key="m" data-finger="right-index">M</div>
                    <div class="key right-middle" data-key="," data-finger="right-middle">,</div>
                    <div class="key right-ring" data-key="." data-finger="right-ring">.</div>
                    <div class="key right-pinky" data-key="/" data-finger="right-pinky">/</div>
                </div>
                <div class="keyboard-row">
                    <div class="key space-key thumbs" data-key="space" data-finger="thumbs">SPACE</div>
                </div>
            </div>
        </div>

        <!-- Finger Position Guide -->
        <div class="finger-guide">
            <div class="finger-guide-title">👆 Finger Position Guide</div>
            <div class="finger-colors">
                <div class="finger-color">
                    <div class="color-dot left-pinky"></div>
                    <span>Left Pinky</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot left-ring"></div>
                    <span>Left Ring</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot left-middle"></div>
                    <span>Left Middle</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot left-index"></div>
                    <span>Left Index</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot thumbs"></div>
                    <span>Thumbs</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot right-index"></div>
                    <span>Right Index</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot right-middle"></div>
                    <span>Right Middle</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot right-ring"></div>
                    <span>Right Ring</span>
                </div>
                <div class="finger-color">
                    <div class="color-dot right-pinky"></div>
                    <span>Right Pinky</span>
                </div>
            </div>
        </div>

        <!-- Advanced Sound Panel -->
        <div class="sound-panel">
            <div class="sound-title">🎵 Advanced Sound System</div>
            <div class="sound-options">
                <div class="sound-option">
                    <span>Typing Volume</span>
                    <input type="range" class="sound-slider" id="typingVolume" min="0" max="100" value="50">
                </div>
                <div class="sound-option">
                    <span>Error Sound</span>
                    <input type="range" class="sound-slider" id="errorVolume" min="0" max="100" value="70">
                </div>
                <div class="sound-option">
                    <span>Success Sound</span>
                    <input type="range" class="sound-slider" id="successVolume" min="0" max="100" value="60">
                </div>
                <div class="sound-option">
                    <span>Background Music</span>
                    <input type="range" class="sound-slider" id="musicVolume" min="0" max="100" value="20">
                </div>
                <div class="sound-option">
                    <span>Sound Pack</span>
                    <select id="soundPack">
                        <option value="mechanical">Mechanical</option>
                        <option value="typewriter">Typewriter</option>
                        <option value="futuristic">Futuristic</option>
                        <option value="nature">Nature</option>
                        <option value="silent">Silent</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Multiplayer Race Simulation -->
        <div class="multiplayer-panel">
            <div class="multiplayer-title">🏎️ Live Race Simulation</div>
            <div class="race-track">
                <div class="racer">
                    <div class="racer-avatar">YOU</div>
                    <div class="racer-info">
                        <div class="racer-name">You</div>
                        <div class="racer-progress">
                            <div class="racer-progress-fill" id="playerProgress" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="racer-stats">
                        <span id="playerWpm">0 WPM</span>
                        <span id="playerPos">1st</span>
                    </div>
                </div>
                <div class="racer">
                    <div class="racer-avatar">AI1</div>
                    <div class="racer-info">
                        <div class="racer-name">SpeedDemon</div>
                        <div class="racer-progress">
                            <div class="racer-progress-fill" id="ai1Progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="racer-stats">
                        <span id="ai1Wpm">0 WPM</span>
                        <span id="ai1Pos">2nd</span>
                    </div>
                </div>
                <div class="racer">
                    <div class="racer-avatar">AI2</div>
                    <div class="racer-info">
                        <div class="racer-name">TypeMaster</div>
                        <div class="racer-progress">
                            <div class="racer-progress-fill" id="ai2Progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="racer-stats">
                        <span id="ai2Wpm">0 WPM</span>
                        <span id="ai2Pos">3rd</span>
                    </div>
                </div>
                <div class="racer">
                    <div class="racer-avatar">AI3</div>
                    <div class="racer-info">
                        <div class="racer-name">KeyboardNinja</div>
                        <div class="racer-progress">
                            <div class="racer-progress-fill" id="ai3Progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="racer-stats">
                        <span id="ai3Wpm">0 WPM</span>
                        <span id="ai3Pos">4th</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Achievements Panel -->
        <div class="achievements-panel">
            <div class="achievements-title">🏆 Achievement System</div>
            <div class="achievement-categories">
                <div class="category-btn active" data-category="speed">Speed</div>
                <div class="category-btn" data-category="accuracy">Accuracy</div>
                <div class="category-btn" data-category="endurance">Endurance</div>
                <div class="category-btn" data-category="special">Special</div>
                <div class="category-btn" data-category="daily">Daily</div>
            </div>
            <div class="achievement-grid" id="achievementGrid">
                <div class="achievement" data-achievement="first-test" data-category="speed">
                    <div class="achievement-icon">🎯</div>
                    <div class="achievement-title">First Steps</div>
                    <div class="achievement-desc">Complete your first typing test</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="speed-demon" data-category="speed">
                    <div class="achievement-icon">⚡</div>
                    <div class="achievement-title">Speed Demon</div>
                    <div class="achievement-desc">Reach 80+ WPM</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="lightning-fingers" data-category="speed">
                    <div class="achievement-icon">⚡</div>
                    <div class="achievement-title">Lightning Fingers</div>
                    <div class="achievement-desc">Reach 100+ WPM</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="accuracy-master" data-category="accuracy">
                    <div class="achievement-icon">🎪</div>
                    <div class="achievement-title">Accuracy Master</div>
                    <div class="achievement-desc">Achieve 98%+ accuracy</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="perfectionist" data-category="accuracy">
                    <div class="achievement-icon">💎</div>
                    <div class="achievement-title">Perfectionist</div>
                    <div class="achievement-desc">Complete a test with 100% accuracy</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="error-free" data-category="accuracy">
                    <div class="achievement-icon">✨</div>
                    <div class="achievement-title">Error Free</div>
                    <div class="achievement-desc">Complete 5 tests with 0 errors</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="marathon-runner" data-category="endurance">
                    <div class="achievement-icon">🏃</div>
                    <div class="achievement-title">Marathon Runner</div>
                    <div class="achievement-desc">Complete a 5-minute test</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="consistency-king" data-category="endurance">
                    <div class="achievement-icon">👑</div>
                    <div class="achievement-title">Consistency King</div>
                    <div class="achievement-desc">Maintain ±5 WPM variance for 5 tests</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="streak-master" data-category="daily">
                    <div class="achievement-icon">🔥</div>
                    <div class="achievement-title">Streak Master</div>
                    <div class="achievement-desc">Maintain a 7-day streak</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="flow-state" data-category="special">
                    <div class="achievement-icon">🌊</div>
                    <div class="achievement-title">Flow State</div>
                    <div class="achievement-desc">Maintain 90%+ flow for 60 seconds</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="night-owl" data-category="special">
                    <div class="achievement-icon">🦉</div>
                    <div class="achievement-title">Night Owl</div>
                    <div class="achievement-desc">Complete 10 tests after midnight</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="achievement" data-achievement="early-bird" data-category="special">
                    <div class="achievement-icon">🐦</div>
                    <div class="achievement-title">Early Bird</div>
                    <div class="achievement-desc">Complete 10 tests before 6 AM</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Lessons Panel -->
        <div class="lessons-panel" id="lessonsPanel" style="display: none;">
            <div class="lessons-title">📚 Interactive Typing Lessons</div>
            <div class="lesson-categories">
                <div class="lesson-category" data-lesson="basics">
                    <div class="lesson-category-title">🔤 Basics</div>
                    <div class="lesson-category-desc">Learn proper finger placement and basic typing techniques</div>
                    <div class="lesson-progress">
                        <span>0/10</span>
                        <div class="lesson-progress-bar">
                            <div class="lesson-progress-fill" style="width: 0%;"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
                <div class="lesson-category" data-lesson="numbers">
                    <div class="lesson-category-title">🔢 Numbers</div>
                    <div class="lesson-category-desc">Master the number row and numeric keypad</div>
                    <div class="lesson-progress">
                        <span>0/8</span>
                        <div class="lesson-progress-bar">
                            <div class="lesson-progress-fill" style="width: 0%;"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
                <div class="lesson-category" data-lesson="symbols">
                    <div class="lesson-category-title">⚡ Symbols</div>
                    <div class="lesson-category-desc">Practice special characters and punctuation</div>
                    <div class="lesson-progress">
                        <span>0/12</span>
                        <div class="lesson-progress-bar">
                            <div class="lesson-progress-fill" style="width: 0%;"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
                <div class="lesson-category" data-lesson="programming">
                    <div class="lesson-category-title">💻 Programming</div>
                    <div class="lesson-category-desc">Code-specific typing with brackets, operators, and syntax</div>
                    <div class="lesson-progress">
                        <span>0/15</span>
                        <div class="lesson-progress-bar">
                            <div class="lesson-progress-fill" style="width: 0%;"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
                <div class="lesson-category" data-lesson="advanced">
                    <div class="lesson-category-title">🚀 Advanced</div>
                    <div class="lesson-category-desc">Speed building and advanced techniques</div>
                    <div class="lesson-progress">
                        <span>0/20</span>
                        <div class="lesson-progress-bar">
                            <div class="lesson-progress-fill" style="width: 0%;"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
                <div class="lesson-category" data-lesson="languages">
                    <div class="lesson-category-title">🌍 Languages</div>
                    <div class="lesson-category-desc">Practice typing in different languages and layouts</div>
                    <div class="lesson-progress">
                        <span>0/25</span>
                        <div class="lesson-progress-bar">
                            <div class="lesson-progress-fill" style="width: 0%;"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Leaderboard -->
        <div class="leaderboard">
            <div class="leaderboard-title">🥇 Global Leaderboards</div>
            <div class="leaderboard-tabs">
                <div class="leaderboard-tab active" data-tab="personal">Personal Best</div>
                <div class="leaderboard-tab" data-tab="daily">Daily</div>
                <div class="leaderboard-tab" data-tab="weekly">Weekly</div>
                <div class="leaderboard-tab" data-tab="alltime">All Time</div>
                <div class="leaderboard-tab" data-tab="friends">Friends</div>
            </div>
            <div id="leaderboardEntries">
                <div class="leaderboard-entry">
                    <div class="leaderboard-rank">#1</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">Your Best Classic</div>
                        <div class="leaderboard-details">Today • 98.5% accuracy</div>
                    </div>
                    <div class="leaderboard-score" id="bestClassic">0 WPM</div>
                    <div class="leaderboard-medal">🥇</div>
                </div>
                <div class="leaderboard-entry">
                    <div class="leaderboard-rank">#2</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">Your Best Marathon</div>
                        <div class="leaderboard-details">Yesterday • 96.2% accuracy</div>
                    </div>
                    <div class="leaderboard-score" id="bestMarathon">0 WPM</div>
                    <div class="leaderboard-medal">🥈</div>
                </div>
                <div class="leaderboard-entry">
                    <div class="leaderboard-rank">#3</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">Your Best Accuracy</div>
                        <div class="leaderboard-details">This week • Perfect score</div>
                    </div>
                    <div class="leaderboard-score" id="bestAccuracy">100%</div>
                    <div class="leaderboard-medal">🥉</div>
                </div>
                <div class="leaderboard-entry">
                    <div class="leaderboard-rank">#4</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">Longest Streak</div>
                        <div class="leaderboard-details">Current streak</div>
                    </div>
                    <div class="leaderboard-score" id="longestStreak">0 days</div>
                    <div class="leaderboard-medal">🔥</div>
                </div>
                <div class="leaderboard-entry">
                    <div class="leaderboard-rank">#5</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">Total Tests</div>
                        <div class="leaderboard-details">All time</div>
                    </div>
                    <div class="leaderboard-score" id="totalTests">0</div>
                    <div class="leaderboard-medal">📊</div>
                </div>
            </div>
        </div>

        <!-- Enhanced Control Panel -->
        <div class="control-panel">
            <button class="btn" id="restartBtn">🔄 Restart Test</button>
            <button class="btn secondary" id="pauseBtn">⏸️ Pause</button>
            <button class="btn tertiary" id="focusModeBtn">🎯 Focus Mode</button>
            <button class="btn secondary" id="exportBtn">📊 Export Results</button>
            <button class="btn tertiary" id="settingsBtn">⚙️ Advanced Settings</button>
            <button class="btn secondary" id="coachBtn">🤖 AI Coach</button>
            <button class="btn tertiary" id="challengeBtn">🏆 Daily Challenge</button>
            <button class="btn secondary" id="shareBtn">📤 Share Progress</button>
        </div>
    </div>

    <!-- Flow State Indicator -->
    <div class="flow-indicator">
        <div class="flow-fill" id="flowIndicator"></div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode" id="focusMode">
        <div class="focus-content">
            <div class="typing-prompt">
                <div class="sentence" id="focusSentence"></div>
            </div>
            <input type="text" class="typing-input" id="focusInput" placeholder="Focus mode activated..." autocomplete="off" spellcheck="false">
            <div style="margin-top: 20px;">
                <button class="btn secondary" onclick="exitFocusMode()">Exit Focus Mode</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Game Over Modal -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2>🎯 Test Complete!</h2>
            <div class="performance-grade" id="performanceGrade">A</div>
            
            <div class="final-stats">
                <div class="final-stat">
                    <div class="final-stat-value" id="finalWpm">0</div>
                    <div class="final-stat-label">Final WPM</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalAccuracy">100%</div>
                    <div class="final-stat-label">Accuracy</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalErrors">0</div>
                    <div class="final-stat-label">Errors</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalChars">0</div>
                    <div class="final-stat-label">Characters</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalWords">0</div>
                    <div class="final-stat-label">Words</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalTime">60s</div>
                    <div class="final-stat-label">Time</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalConsistency">0%</div>
                    <div class="final-stat-label">Consistency</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalFlow">0%</div>
                    <div class="final-stat-label">Flow State</div>
                </div>
            </div>

            <div class="performance-analysis">
                <div class="analysis-title">📊 Performance Analysis</div>
                <div class="analysis-item">
                    <span class="analysis-label">Peak WPM</span>
                    <span class="analysis-value" id="peakWpm">0</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Average WPM</span>
                    <span class="analysis-value" id="avgWpmFinal">0</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Typing Rhythm</span>
                    <span class="analysis-value" id="typingRhythm">Steady</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Most Difficult Word</span>
                    <span class="analysis-value" id="difficultWord">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Improvement Suggestion</span>
                    <span class="analysis-value" id="improvementSuggestion">Keep practicing!</span>
                </div>
            </div>

            <div style="margin: 25px 0;">
                <div id="newRecordMessage" style="color: var(--primary-green); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;"></div>
                <div id="improvementTip" style="color: var(--text-secondary); font-style: italic; line-height: 1.4;"></div>
                <div id="aiCoachTip" style="color: var(--primary-cyan); font-weight: 600; margin-top: 10px;"></div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="restartGame()">🚀 Try Again</button>
                <button class="btn secondary" onclick="shareResults()">📤 Share Results</button>
                <button class="btn tertiary" onclick="viewDetailedAnalytics()">📊 Detailed Analytics</button>
                <button class="btn secondary" onclick="saveToProfile()">💾 Save to Profile</button>
            </div>
        </div>
    </div>

    <!-- Advanced Notification Container -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <div class="notification-icon" id="notificationIcon">🎉</div>
            <div class="notification-title" id="notificationTitle">Success!</div>
        </div>
        <div class="notification-content" id="notificationContent"></div>
    </div>

    <script>
        class UltimateTypingTestPro {
            constructor() {
                // Enhanced sentence collections
                this.sentences = {
                    easy: [
                        "The quick brown fox jumps over the lazy dog near the riverbank.",
                        "A journey of a thousand miles begins with a single step forward.",
                        "Life is what happens when you are busy making other plans for tomorrow.",
                        "The only way to do great work is to love what you do every day.",
                        "Innovation distinguishes between a leader and a follower in any field.",
                        "Success is not final, failure is not fatal, it is the courage to continue.",
                        "The best time to plant a tree was twenty years ago, the second best time is now.",
                        "Your limitation is only your imagination and willingness to work hard.",
                        "Great things never come from comfort zones, so step out and explore.",
                        "Dream big and dare to fail, for failure is just another step to success."
                    ],
                    medium: [
                        "Technology has revolutionized the way we communicate and work in modern society today.",
                        "Programming requires patience, practice, and persistent problem-solving skills to master effectively.",
                        "Artificial intelligence is transforming industries across the globe at an unprecedented pace.",
                        "The beauty of nature lies in its complexity and the harmony of its ecosystems.",
                        "Success comes to those who dare to begin and persist through challenges and obstacles.",
                        "Climate change represents one of the most significant challenges facing humanity today.",
                        "Education is the most powerful weapon which you can use to change the world.",
                        "The internet has connected billions of people and created new opportunities for collaboration.",
                        "Renewable energy sources are becoming increasingly important for sustainable development.",
                        "Scientific research continues to push the boundaries of human knowledge and understanding."
                    ],
                    hard: [
                        "Quantum computing represents a paradigm shift in computational capabilities, leveraging quantum mechanical phenomena to process information exponentially faster than classical computers.",
                        "Cryptocurrency and blockchain technology are revolutionizing financial systems through decentralized architectures that eliminate traditional intermediaries and enable peer-to-peer transactions.",
                        "Machine learning algorithms utilize statistical techniques to enable computers to improve performance automatically through experience without being explicitly programmed for each task.",
                        "Biotechnology innovations are advancing personalized medicine through genomic sequencing and targeted therapies that address individual genetic variations and disease susceptibilities.",
                        "Sustainable development requires balancing economic growth with environmental conservation and social equity to ensure long-term prosperity for future generations.",
                        "Nanotechnology involves manipulating matter at the atomic and molecular scale to create materials and devices with novel properties and applications across multiple industries.",
                        "Cybersecurity threats are evolving rapidly as malicious actors develop sophisticated techniques to exploit vulnerabilities in interconnected digital systems and infrastructure.",
                        "Neuroscience research is uncovering the complex mechanisms underlying consciousness, memory formation, and cognitive processes that define human intelligence and behavior.",
                        "Space exploration continues to expand our understanding of the universe while driving technological innovations that benefit life on Earth through scientific advancement.",
                        "Genetic engineering techniques like CRISPR-Cas9 are enabling precise modifications to DNA sequences, opening new possibilities for treating genetic disorders and enhancing crops."
                    ],
                    programming: [
                        "function calculateFactorial(n) { return n <= 1 ? 1 : n * calculateFactorial(n - 1); }",
                        "const asyncFunction = async () => { const response = await fetch('/api/data'); return response.json(); }",
                        "class DataStructure { constructor() { this.items = []; } push(item) { this.items.push(item); } }",
                        "import React, { useState, useEffect } from 'react'; const Component = () => { const [state, setState] = useState(null); };",
                        "SELECT users.name, COUNT(orders.id) as order_count FROM users LEFT JOIN orders ON users.id = orders.user_id GROUP BY users.id;",
                        "def binary_search(arr, target): left, right = 0, len(arr) - 1; while left <= right: mid = (left + right) // 2;",
                        "public class QuickSort { public static void quickSort(int[] arr, int low, int high) { if (low < high) { int pi = partition(arr, low, high); } } }",
                        "const debounce = (func, delay) => { let timeoutId; return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func.apply(this, args), delay); }; };",
                        "interface User { id: number; name: string; email: string; } type UserAction = 'create' | 'update' | 'delete';",
                        "git add . && git commit -m 'feat: implement advanced typing test with real-time analytics' && git push origin main"
                    ],
                    quotes: [
                        "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
                        "It is during our darkest moments that we must focus to see the light. - Aristotle",
                        "The way to get started is to quit talking and begin doing. - Walt Disney",
                        "Innovation distinguishes between a leader and a follower. - Steve Jobs",
                        "Life is what happens to you while you're busy making other plans. - John Lennon",
                        "The only impossible journey is the one you never begin. - Tony Robbins",
                        "In the midst of winter, I found there was, within me, an invincible summer. - Albert Camus",
                        "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill",
                        "The only way to do great work is to love what you do. - Steve Jobs",
                        "Believe you can and you're halfway there. - Theodore Roosevelt"
                    ]
                };

                // Enhanced achievements system
                this.achievements = {
                    'first-test': { name: 'First Steps', description: 'Complete your first typing test', unlocked: false, category: 'speed', progress: 0, target: 1 },
                    'speed-demon': { name: 'Speed Demon', description: 'Reach 80+ WPM', unlocked: false, category: 'speed', progress: 0, target: 80 },
                    'lightning-fingers': { name: 'Lightning Fingers', description: 'Reach 100+ WPM', unlocked: false, category: 'speed', progress: 0, target: 100 },
                    'accuracy-master': { name: 'Accuracy Master', description: 'Achieve 98%+ accuracy', unlocked: false, category: 'accuracy', progress: 0, target: 98 },
                    'perfectionist': { name: 'Perfectionist', description: 'Complete a test with 100% accuracy', unlocked: false, category: 'accuracy', progress: 0, target: 100 },
                    'error-free': { name: 'Error Free', description: 'Complete 5 tests with 0 errors', unlocked: false, category: 'accuracy', progress: 0, target: 5 },
                    'marathon-runner': { name: 'Marathon Runner', description: 'Complete a 5-minute test', unlocked: false, category: 'endurance', progress: 0, target: 1 },
                    'consistency-king': { name: 'Consistency King', description: 'Maintain ±5 WPM variance for 5 tests', unlocked: false, category: 'endurance', progress: 0, target: 5 },
                    'streak-master': { name: 'Streak Master', description: 'Maintain a 7-day streak', unlocked: false, category: 'daily', progress: 0, target: 7 },
                    'flow-state': { name: 'Flow State', description: 'Maintain 90%+ flow for 60 seconds', unlocked: false, category: 'special', progress: 0, target: 90 },
                    'night-owl': { name: 'Night Owl', description: 'Complete 10 tests after midnight', unlocked: false, category: 'special', progress: 0, target: 10 },
                    'early-bird': { name: 'Early Bird', description: 'Complete 10 tests before 6 AM', unlocked: false, category: 'special', progress: 0, target: 10 }
                };

                // Advanced sound system
                this.soundSystem = {
                    enabled: true,
                    volumes: {
                        typing: 50,
                        error: 70,
                        success: 60,
                        music: 20
                    },
                    pack: 'mechanical',
                    audioContext: null,
                    sounds: {},
                    backgroundMusic: null
                };

                // Game state variables
                this.gameMode = 'classic';
                this.difficulty = 'medium';
                this.currentSentence = '';
                this.currentIndex = 0;
                this.startTime = null;
                this.timeLeft = 60;
                this.timer = null;
                this.isGameActive = false;
                this.isPaused = false;
                this.correctChars = 0;
                this.totalChars = 0;
                this.errors = 0;
                this.currentWpm = 0;
                this.currentAccuracy = 100;
                this.peakWpm = 0;
                this.flowState = 0; // 0-100%
                this.consistency = 100; // 0-100%
                this.rhythm = 0; // Average time between key presses

                // Advanced tracking
                this.wpmHistory = []; // For chart
                this.accuracyHistory = []; // For chart
                this.keyPressCount = {}; // For heatmap
                this.keyPressTimings = []; // For rhythm analysis
                this.errorPatterns = {}; // For error analysis
                this.burstDetection = { lastWpm: 0, threshold: 10, lastBurstTime: 0 };
                this.focusModeActive = false;
                this.theme = 'cyberpunk';
                this.totalWordsTyped = 0;
                this.totalTestsCompleted = 0;
                this.bestOverallWpm = 0;
                this.avgOverallWpm = 0;
                this.streak = 0;
                this.lastPlayDate = null;
                this.errorFreeTests = 0; // For 'error-free' achievement
                this.wpmHistoryForConsistency = []; // For 'consistency-king' achievement

                // Race simulation
                this.raceOpponents = [];
                this.aiWpmRanges = {
                    easy: [20, 40],
                    medium: [40, 70],
                    hard: [70, 100]
                };
                this.aiProgress = { ai1: 0, ai2: 0, ai3: 0 };
                this.aiCurrentWpm = { ai1: 0, ai2: 0, ai3: 0 };

                // Initialize everything
                this.loadUserData();
                this.initializeElements();
                this.setupEventListeners();
                this.initializeSoundSystem();
                this.loadNewSentence();
                this.updateAllDisplays();
                this.updateAchievementsDisplay();
                this.updateLeaderboard();
                this.initializeChart();
                this.initializeRaceOpponents();
                this.startBackgroundMusic();
                this.checkTimeBasedAchievements();
            }

            initializeElements() {
                // Get all DOM elements
                this.sentenceEl = document.getElementById('sentence');
                this.inputEl = document.getElementById('typingInput');
                this.timerEl = document.getElementById('timer');
                this.wpmEl = document.getElementById('wpm');
                this.accuracyEl = document.getElementById('accuracy');
                this.errorsEl = document.getElementById('errors');
                this.bestWpmEl = document.getElementById('bestWpm');
                this.avgWpmEl = document.getElementById('avgWpm');
                this.rhythmEl = document.getElementById('rhythm');
                this.flowStateEl = document.getElementById('flowState');
                this.restartBtn = document.getElementById('restartBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.settingsBtn = document.getElementById('settingsBtn');
                this.gameOverEl = document.getElementById('gameOver');
                this.progressFill = document.getElementById('progressFill');
                this.flowFill = document.getElementById('flowFill');
                this.streakCount = document.getElementById('streakCount');
                this.difficultyIndicator = document.getElementById('difficultyIndicator');
                this.themeSelector = document.getElementById('themeSelector');
                this.soundToggle = document.getElementById('soundToggle');
                this.profileBtn = document.getElementById('profileBtn');
                this.notificationEl = document.getElementById('notification');
                this.notificationContent = document.getElementById('notificationContent');
                this.notificationTitle = document.getElementById('notificationTitle');
                this.notificationIcon = document.getElementById('notificationIcon');
                this.wpmLine = document.getElementById('wpmLine');
                this.accuracyLine = document.getElementById('accuracyLine');
                this.burstIndicator = document.getElementById('burstIndicator');
                this.burstText = document.getElementById('burstText');
                this.flowIndicator = document.getElementById('flowIndicator');
                this.focusMode = document.getElementById('focusMode');
                this.focusModeBtn = document.getElementById('focusModeBtn');
                this.lessonsBtn = document.getElementById('lessonsBtn');
                this.lessonsPanel = document.getElementById('lessonsPanel');
                this.coachBtn = document.getElementById('coachBtn');
                this.challengeBtn = document.getElementById('challengeBtn');
                this.shareBtn = document.getElementById('shareBtn');

                // Live stats elements
                this.liveWpm = document.getElementById('liveWpm');
                this.liveAccuracy = document.getElementById('liveAccuracy');
                this.wordsTyped = document.getElementById('wordsTyped');

                // Race elements
                this.playerProgress = document.getElementById('playerProgress');
                this.playerWpm = document.getElementById('playerWpm');
                this.playerPos = document.getElementById('playerPos');
                this.ai1Progress = document.getElementById('ai1Progress');
                this.ai1Wpm = document.getElementById('ai1Wpm');
                this.ai1Pos = document.getElementById('ai1Pos');
                this.ai2Progress = document.getElementById('ai2Progress');
                this.ai2Wpm = document.getElementById('ai2Wpm');
                this.ai2Pos = document.getElementById('ai2Progress');
                this.ai3Progress = document.getElementById('ai3Progress');
                this.ai3Wpm = document.getElementById('ai3Wpm');
                this.ai3Pos = document.getElementById('ai3Pos');

                // Sound control elements
                this.typingVolume = document.getElementById('typingVolume');
                this.errorVolume = document.getElementById('errorVolume');
                this.successVolume = document.getElementById('successVolume');
                this.musicVolume = document.getElementById('musicVolume');
                this.soundPackSelector = document.getElementById('soundPack');

                // Game Over Modal elements
                this.finalWpmEl = document.getElementById('finalWpm');
                this.finalAccuracyEl = document.getElementById('finalAccuracy');
                this.finalErrorsEl = document.getElementById('finalErrors');
                this.finalCharsEl = document.getElementById('finalChars');
                this.finalWordsEl = document.getElementById('finalWords');
                this.finalTimeEl = document.getElementById('finalTime');
                this.finalConsistencyEl = document.getElementById('finalConsistency');
                this.finalFlowEl = document.getElementById('finalFlow');
                this.peakWpmEl = document.getElementById('peakWpm');
                this.avgWpmFinalEl = document.getElementById('avgWpmFinal');
                this.typingRhythmEl = document.getElementById('typingRhythm');
                this.difficultWordEl = document.getElementById('difficultWord');
                this.improvementSuggestionEl = document.getElementById('improvementSuggestion');
                this.newRecordMessageEl = document.getElementById('newRecordMessage');
                this.aiCoachTipEl = document.getElementById('aiCoachTip');

                // Leaderboard elements
                this.bestClassicEl = document.getElementById('bestClassic');
                this.bestMarathonEl = document.getElementById('bestMarathon');
                this.bestAccuracyEl = document.getElementById('bestAccuracy');
                this.longestStreakEl = document.getElementById('longestStreak');
                this.totalTestsEl = document.getElementById('totalTests');

                // Set initial values for selectors
                this.themeSelector.value = this.theme;
                document.documentElement.className = `theme-${this.theme}`;
                this.soundPackSelector.value = this.soundSystem.pack;
                this.typingVolume.value = this.soundSystem.volumes.typing;
                this.errorVolume.value = this.soundSystem.volumes.error;
                this.successVolume.value = this.soundSystem.volumes.success;
                this.musicVolume.value = this.soundSystem.volumes.music;
                this.soundToggle.textContent = this.soundSystem.enabled ? '🔊 Sound ON' : '🔇 Sound OFF';
            }

            setupEventListeners() {
                // Main input events
                this.inputEl.addEventListener('input', (e) => this.handleInput(e));
                this.inputEl.addEventListener('keydown', (e) => this.handleKeyDown(e));

                // Control buttons
                this.restartBtn.addEventListener('click', () => this.restartGame());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.exportBtn.addEventListener('click', () => this.exportResults());
                this.settingsBtn.addEventListener('click', () => this.openAdvancedSettings());
                this.coachBtn.addEventListener('click', () => this.openAICoach());
                this.challengeBtn.addEventListener('click', () => this.startDailyChallenge());
                this.shareBtn.addEventListener('click', () => this.shareProgress());

                // Navigation controls
                this.themeSelector.addEventListener('change', (e) => this.changeTheme(e.target.value));
                this.soundToggle.addEventListener('click', () => this.toggleSound());
                this.profileBtn.addEventListener('click', () => this.openProfile());
                this.focusModeBtn.addEventListener('click', () => this.enterFocusMode());
                this.lessonsBtn.addEventListener('click', () => this.toggleLessons());

                // Mode selector
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.addEventListener('click', () => this.selectGameMode(card.dataset.mode));
                });

                // Achievement categories
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.filterAchievements(btn.dataset.category));
                });

                // Leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchLeaderboardTab(tab.dataset.tab));
                });

                // Lesson categories
                document.querySelectorAll('.lesson-category').forEach(category => {
                    category.addEventListener('click', () => this.startLesson(category.dataset.lesson));
                });

                // Sound controls
                this.typingVolume.addEventListener('input', (e) => this.updateSoundVolume('typing', e.target.value));
                this.errorVolume.addEventListener('input', (e) => this.updateSoundVolume('error', e.target.value));
                this.successVolume.addEventListener('input', (e) => this.updateSoundVolume('success', e.target.value));
                this.musicVolume.addEventListener('input', (e) => this.updateSoundVolume('music', e.target.value));
                this.soundPackSelector.addEventListener('change', (e) => this.changeSoundPack(e.target.value));

                // Keyboard event for heatmap
                document.addEventListener('keydown', (e) => this.updateKeyboardHeatmap(e.key.toLowerCase()));

                // Global keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'r':
                                e.preventDefault();
                                this.restartGame();
                                break;
                            case 'p':
                                e.preventDefault();
                                this.togglePause();
                                break;
                            case 'f':
                                e.preventDefault();
                                this.enterFocusMode();
                                break;
                            case 's':
                                e.preventDefault();
                                this.exportResults();
                                break;
                        }
                    }
                    
                    if (e.key === 'Escape') {
                        if (this.focusModeActive) {
                            this.exitFocusMode();
                        } else {
                            const gameOver = document.getElementById('gameOver');
                            if (gameOver.classList.contains('show')) {
                                this.restartGame();
                            }
                        }
                    }
                });

                // Window events
                window.addEventListener('beforeunload', () => this.saveUserData());
                window.addEventListener('blur', () => {
                    if (this.isGameActive && !this.isPaused) {
                        this.togglePause();
                    }
                });
            }

            loadUserData() {
                const userData = JSON.parse(localStorage.getItem('ultimateTypingProData')) || {};
                this.bestOverallWpm = userData.bestOverallWpm || 0;
                this.avgOverallWpm = userData.avgOverallWpm || 0;
                this.streak = userData.streak || 0;
                this.lastPlayDate = userData.lastPlayDate || null;
                this.totalWordsTyped = userData.totalWordsTyped || 0;
                this.totalTestsCompleted = userData.totalTestsCompleted || 0;
                this.errorFreeTests = userData.errorFreeTests || 0;
                this.wpmHistoryForConsistency = userData.wpmHistoryForConsistency || [];
                this.achievements = { ...this.achievements, ...(userData.achievements || {}) };
                this.soundSystem.enabled = userData.soundEnabled !== undefined ? userData.soundEnabled : true;
                this.soundSystem.volumes = { ...this.soundSystem.volumes, ...(userData.soundVolumes || {}) };
                this.soundSystem.pack = userData.soundPack || 'mechanical';
                this.theme = userData.theme || 'cyberpunk';

                this.updateStreak();
            }

            saveUserData() {
                const userData = {
                    bestOverallWpm: this.bestOverallWpm,
                    avgOverallWpm: this.avgOverallWpm,
                    streak: this.streak,
                    lastPlayDate: this.lastPlayDate,
                    totalWordsTyped: this.totalWordsTyped,
                    totalTestsCompleted: this.totalTestsCompleted,
                    errorFreeTests: this.errorFreeTests,
                    wpmHistoryForConsistency: this.wpmHistoryForConsistency,
                    achievements: this.achievements,
                    soundEnabled: this.soundSystem.enabled,
                    soundVolumes: this.soundSystem.volumes,
                    soundPack: this.soundSystem.pack,
                    theme: this.theme
                };
                localStorage.setItem('ultimateTypingProData', JSON.stringify(userData));
            }

            initializeSoundSystem() {
                try {
                    this.soundSystem.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.loadBackgroundMusic();
                } catch (error) {
                    console.warn('Audio context not supported:', error);
                    this.soundSystem.enabled = false;
                }
            }

            loadBackgroundMusic() {
                if (!this.soundSystem.audioContext) return;

                // Placeholder for background music. In a real app, you'd load an actual audio file.
                // For this demo, we'll use a simple oscillating tone.
                this.soundSystem.backgroundMusic = this.soundSystem.audioContext.createOscillator();
                this.soundSystem.backgroundMusic.type = 'sine';
                this.soundSystem.backgroundMusic.frequency.setValueAtTime(100, this.soundSystem.audioContext.currentTime); // Low hum

                const gainNode = this.soundSystem.audioContext.createGain();
                gainNode.gain.setValueAtTime(this.soundSystem.volumes.music / 100 * 0.05, this.soundSystem.audioContext.currentTime); // Low volume
                
                this.soundSystem.backgroundMusic.connect(gainNode);
                gainNode.connect(this.soundSystem.audioContext.destination);
                
                this.soundSystem.backgroundMusic.start(0);
                this.soundSystem.backgroundMusic.stop(this.soundSystem.audioContext.currentTime + 999999); // Play for a very long time
            }

            startBackgroundMusic() {
                if (this.soundSystem.backgroundMusic && this.soundSystem.enabled) {
                    this.soundSystem.backgroundMusic.gain.setValueAtTime(this.soundSystem.volumes.music / 100 * 0.05, this.soundSystem.audioContext.currentTime);
                }
            }

            stopBackgroundMusic() {
                if (this.soundSystem.backgroundMusic) {
                    this.soundSystem.backgroundMusic.gain.setValueAtTime(0, this.soundSystem.audioContext.currentTime);
                }
            }

            updateSoundVolume(type, value) {
                this.soundSystem.volumes[type] = parseInt(value);
                this.saveUserData();
                if (type === 'music' && this.soundSystem.backgroundMusic) {
                    this.soundSystem.backgroundMusic.gain.setValueAtTime(this.soundSystem.volumes.music / 100 * 0.05, this.soundSystem.audioContext.currentTime);
                }
                this.showNotification('🎵 Sound Settings', `Volume for ${type} set to ${value}%`, 'info');
            }

            toggleSound() {
                this.soundSystem.enabled = !this.soundSystem.enabled;
                this.soundToggle.textContent = this.soundSystem.enabled ? '🔊 Sound ON' : '🔇 Sound OFF';
                if (this.soundSystem.enabled) {
                    this.startBackgroundMusic();
                    this.showNotification('🔊 Sound Enabled', 'All sounds are now active.', 'success');
                } else {
                    this.stopBackgroundMusic();
                    this.showNotification('🔇 Sound Disabled', 'All sounds are now muted.', 'warning');
                }
                this.saveUserData();
            }

            changeSoundPack(packName) {
                this.soundSystem.pack = packName;
                this.showNotification('🎵 Sound Pack', `Changed to ${packName} pack!`, 'success');
                this.saveUserData();
                // Play a sample sound
                if (this.soundSystem.enabled && this.soundSystem.audioContext) {
                    this.playSound('typing');
                }
            }

            playSound(type) {
                if (!this.soundSystem.enabled || this.soundSystem.pack === 'silent' || !this.soundSystem.audioContext) return;
                
                const ctx = this.soundSystem.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                const filter = ctx.createBiquadFilter();

                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(ctx.destination);

                let frequency, duration, volume;

                switch (this.soundSystem.pack) {
                    case 'mechanical':
                        oscillator.type = 'square';
                        frequency = 800 + Math.random() * 200;
                        duration = 0.1;
                        volume = this.soundSystem.volumes.typing / 100 * 0.1;
                        filter.type = 'lowpass';
                        filter.frequency.setValueAtTime(2000, ctx.currentTime);
                        break;
                    case 'typewriter':
                        oscillator.type = 'sawtooth';
                        frequency = 400 + Math.random() * 100;
                        duration = 0.15;
                        volume = this.soundSystem.volumes.typing / 100 * 0.15;
                        filter.type = 'bandpass';
                        filter.frequency.setValueAtTime(1000, ctx.currentTime);
                        break;
                    case 'futuristic':
                        oscillator.type = 'sine';
                        frequency = 1200 + Math.random() * 400;
                        duration = 0.08;
                        volume = this.soundSystem.volumes.typing / 100 * 0.08;
                        filter.type = 'highpass';
                        filter.frequency.setValueAtTime(1500, ctx.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.05);
                        break;
                    case 'nature':
                        // Simulate a soft click/tap with noise
                        const bufferSize = ctx.sampleRate * 0.1;
                        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < bufferSize; i++) {
                            data[i] = (Math.random() * 2 - 1) * 0.05; // Low volume white noise
                        }
                        const source = ctx.createBufferSource();
                        source.buffer = buffer;
                        source.connect(gainNode);
                        gainNode.connect(ctx.destination);
                        gainNode.gain.setValueAtTime(this.soundSystem.volumes.typing / 100 * 0.05, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
                        source.start(ctx.currentTime);
                        return; // Exit early for nature sound as it uses BufferSource
                    default:
                        return; // Silent or unknown pack
                }

                if (type === 'error') {
                    frequency = 200;
                    duration = 0.3;
                    volume = this.soundSystem.volumes.error / 100 * 0.2;
                    oscillator.type = 'sawtooth';
                } else if (type === 'success') {
                    frequency = 800;
                    duration = 0.2;
                    volume = this.soundSystem.volumes.success / 100 * 0.15;
                    oscillator.type = 'sine';
                }

                oscillator.frequency.setValueAtTime(frequency, ctx.currentTime);
                gainNode.gain.setValueAtTime(volume, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            }

            selectGameMode(mode) {
                document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                this.gameMode = mode;
                
                switch(mode) {
                    case 'classic':
                        this.timeLeft = 60;
                        this.difficulty = 'medium';
                        break;
                    case 'marathon':
                        this.timeLeft = 300;
                        this.difficulty = 'medium';
                        break;
                    case 'zen':
                        this.timeLeft = Infinity;
                        this.difficulty = 'easy';
                        break;
                    case 'challenge':
                        this.timeLeft = 60;
                        this.difficulty = 'hard'; // Daily challenge is always hard
                        break;
                    case 'race':
                        this.timeLeft = 60; // Race duration
                        this.difficulty = 'medium'; // AI difficulty
                        this.initializeRaceOpponents();
                        break;
                    case 'custom':
                        this.openCustomTextDialog();
                        return; // Don't load new sentence immediately, wait for custom text
                }
                
                this.timerEl.textContent = this.timeLeft === Infinity ? '∞' : this.timeLeft;
                this.difficultyIndicator.textContent = this.difficulty.charAt(0).toUpperCase() + this.difficulty.slice(1);
                this.loadNewSentence();
                this.showNotification(`🎮 Game Mode`, `Switched to ${mode.charAt(0).toUpperCase() + mode.slice(1)} mode!`, 'success');
                this.restartGame(false); // Restart game state but don't show notification again
            }

            loadNewSentence() {
                let sentences;
                
                if (this.difficulty === 'custom' && this.currentSentence) {
                    this.displaySentence(this.currentSentence);
                    return; // Custom text already set
                }
                
                // Smart difficulty selection based on user performance
                if (this.bestOverallWpm > 80) {
                    sentences = this.sentences.hard;
                } else if (this.bestOverallWpm > 40) {
                    sentences = this.sentences.medium;
                } else {
                    sentences = this.sentences.easy;
                }
                
                // Mix in different types of content for variety
                const contentTypes = ['easy', 'medium', 'hard', 'programming', 'quotes'];
                const randomType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
                
                if (Math.random() < 0.3 && this.sentences[randomType]) { // 30% chance to pick from other categories
                    sentences = this.sentences[randomType];
                }
                
                const randomIndex = Math.floor(Math.random() * sentences.length);
                this.currentSentence = sentences[randomIndex];
                this.displaySentence(this.currentSentence);
            }

            displaySentence(sentence) {
                this.sentenceEl.innerHTML = '';
                sentence.split(' ').forEach((word, wordIndex) => {
                    const wordSpan = document.createElement('span');
                    wordSpan.classList.add('word');
                    word.split('').forEach(char => {
                        const charSpan = document.createElement('span');
                        charSpan.textContent = char;
                        wordSpan.appendChild(charSpan);
                    });
                    this.sentenceEl.appendChild(wordSpan);
                    if (wordIndex < sentence.split(' ').length - 1) {
                        const spaceSpan = document.createElement('span');
                        spaceSpan.textContent = ' ';
                        wordSpan.appendChild(spaceSpan);
                    }
                });
                this.updateCurrentCharHighlight();
            }

            updateCurrentCharHighlight() {
                const allChars = this.sentenceEl.querySelectorAll('span > span');
                allChars.forEach(span => span.classList.remove('current'));
                if (allChars[this.currentIndex]) {
                    allChars[this.currentIndex].classList.add('current');
                }
            }

            handleKeyDown(e) {
                if (!this.isGameActive && !this.isPaused && e.key !== 'Tab' && e.key !== 'Escape') {
                    this.startGame();
                }

                // Prevent space from scrolling
                if (e.key === ' ' && e.target === this.inputEl) {
                    e.preventDefault();
                }
            }

            handleInput(e) {
                if (!this.isGameActive || this.isPaused) return;

                const inputValue = e.target.value;
                const expectedChar = this.currentSentence[this.currentIndex];
                const typedChar = inputValue[this.currentIndex];

                // Handle backspace
                if (e.inputType === 'deleteContentBackward') {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                        this.totalChars--;
                        const charSpan = this.sentenceEl.querySelector(`span > span:nth-child(${this.currentIndex + 1})`);
                        if (charSpan) {
                            charSpan.classList.remove('correct', 'incorrect');
                        }
                        this.updateCurrentCharHighlight();
                    }
                    return;
                }

                // Only process if a new character is typed
                if (typedChar === undefined) return; // Input cleared or not a new character

                this.totalChars++;
                this.keyPressTimings.push(Date.now());

                const charSpan = this.sentenceEl.querySelector(`span > span:nth-child(${this.currentIndex + 1})`);

                if (charSpan) {
                    if (typedChar === expectedChar) {
                        charSpan.classList.add('correct');
                        charSpan.classList.remove('incorrect');
                        this.correctChars++;
                        this.playSound('typing');
                    } else {
                        charSpan.classList.add('incorrect');
                        charSpan.classList.remove('correct');
                        this.errors++;
                        this.playSound('error');
                        this.trackError(expectedChar, typedChar);
                    }
                }

                this.currentIndex++;
                this.updateCurrentCharHighlight();
                this.calculateStats();
                this.updateAllDisplays();
                this.updateLiveChart();
                this.updateFlowState();
                this.updateBurstIndicator();
                this.updateRaceProgress();

                // Check if word is completed
                const currentWordSpans = this.sentenceEl.querySelectorAll('.word');
                let currentWordIndex = 0;
                let charCountInWords = 0;
                for (let i = 0; i < currentWordSpans.length; i++) {
                    const wordLength = currentWordSpans[i].textContent.length;
                    if (this.currentIndex >= charCountInWords && this.currentIndex <= charCountInWords + wordLength) {
                        currentWordIndex = i;
                        break;
                    }
                    charCountInWords += wordLength;
                }

                const currentWordText = currentWordSpans[currentWordIndex].textContent;
                const typedWord = inputValue.substring(charCountInWords - currentWordText.length, this.currentIndex);

                if (typedWord === currentWordText) {
                    currentWordSpans[currentWordIndex].classList.add('completed');
                    this.totalWordsTyped++;
                }

                // Check if sentence is completed
                if (this.currentIndex === this.currentSentence.length) {
                    this.playCompletionEffect();
                    this.inputEl.value = '';
                    this.currentIndex = 0;
                    this.loadNewSentence();
                }
            }

            calculateStats() {
                if (!this.startTime) return;

                const timeElapsedSeconds = (Date.now() - this.startTime) / 1000;
                const timeElapsedMinutes = timeElapsedSeconds / 60;

                // WPM calculation: (correct characters / 5) / time in minutes
                this.currentWpm = timeElapsedMinutes > 0 ? Math.round((this.correctChars / 5) / timeElapsedMinutes) : 0;
                this.peakWpm = Math.max(this.peakWpm, this.currentWpm);

                // Accuracy calculation
                this.currentAccuracy = this.totalChars > 0 ? Math.round((this.correctChars / this.totalChars) * 100) : 100;

                // Store for chart
                this.wpmHistory.push({ time: timeElapsedSeconds, wpm: this.currentWpm });
                this.accuracyHistory.push({ time: timeElapsedSeconds, accuracy: this.currentAccuracy });

                // Keep only last 120 data points for chart performance (2 points per second for 60 seconds)
                if (this.wpmHistory.length > 120) {
                    this.wpmHistory.shift();
                    this.accuracyHistory.shift();
                }

                // Calculate rhythm (average time between last few key presses)
                if (this.keyPressTimings.length > 5) {
                    const recentTimings = this.keyPressTimings.slice(-5);
                    const totalTimeDiff = recentTimings[recentTimings.length - 1] - recentTimings[0];
                    this.rhythm = totalTimeDiff > 0 ? Math.round((recentTimings.length - 1) / (totalTimeDiff / 1000)) : 0; // Keys per second
                }

                // Calculate consistency (variance of WPM over last 10 seconds)
                const recentWpms = this.wpmHistory.filter(point => (timeElapsedSeconds - point.time) <= 10).map(point => point.wpm);
                if (recentWpms.length > 1) {
                    const avg = recentWpms.reduce((sum, w) => sum + w, 0) / recentWpms.length;
                    const variance = recentWpms.reduce((sum, w) => sum + Math.pow(w - avg, 2), 0) / recentWpms.length;
                    this.consistency = Math.max(0, Math.round(100 - Math.sqrt(variance) * 2)); // Scale variance to 0-100
                } else {
                    this.consistency = 100;
                }
            }

            updateAllDisplays() {
                this.wpmEl.textContent = this.currentWpm;
                this.accuracyEl.textContent = `${this.currentAccuracy}%`;
                this.errorsEl.textContent = this.errors;
                this.bestWpmEl.textContent = this.bestOverallWpm;
                this.avgWpmEl.textContent = this.avgOverallWpm;
                this.rhythmEl.textContent = this.rhythm.toFixed(1);
                this.flowStateEl.textContent = `${this.flowState}%`;
                this.streakCount.textContent = this.streak;

                this.liveWpm.textContent = this.currentWpm;
                this.liveAccuracy.textContent = `${this.currentAccuracy}%`;
                this.wordsTyped.textContent = Math.round(this.totalChars / 5);

                // Update progress bar
                if (this.gameMode !== 'zen') {
                    const totalTime = this.gameMode === 'classic' ? 60 : this.gameMode === 'marathon' ? 300 : 60;
                    const progress = ((totalTime - this.timeLeft) / totalTime) * 100;
                    this.progressFill.style.width = `${progress}%`;
                } else {
                    this.progressFill.style.width = '100%'; // Zen mode always full progress
                }
                
                // Update flow state bar
                this.flowIndicator.style.height = `${this.flowState}%`;
                this.flowFill.style.width = `${this.flowState}%`;

                // Update timer styling
                this.timerEl.parentElement.classList.remove('warning', 'critical');
                if (this.timeLeft <= 10 && this.timeLeft > 5) {
                    this.timerEl.parentElement.classList.add('warning');
                } else if (this.timeLeft <= 5) {
                    this.timerEl.parentElement.classList.add('critical');
                }

                this.updateTrends();
                this.updateKeyboardStats();
            }

            updateTrends() {
                const wpmTrendEl = document.getElementById('wpmTrend');
                const accuracyTrendEl = document.getElementById('accuracyTrend');
                const errorTrendEl = document.getElementById('errorTrend');
                const timeTrendEl = document.getElementById('timeTrend');
                const bestTrendEl = document.getElementById('bestTrend');
                const avgTrendEl = document.getElementById('avgTrend');
                const rhythmTrendEl = document.getElementById('rhythmTrend');
                const flowTrendEl = document.getElementById('flowTrend');

                // WPM Trend
                if (this.wpmHistory.length > 10) {
                    const recentAvg = this.wpmHistory.slice(-5).reduce((sum, p) => sum + p.wpm, 0) / 5;
                    const olderAvg = this.wpmHistory.slice(-10, -5).reduce((sum, p) => sum + p.wpm, 0) / 5;
                    if (recentAvg > olderAvg + 2) { wpmTrendEl.textContent = '↗️ Rising'; wpmTrendEl.className = 'stat-trend trend-up'; }
                    else if (recentAvg < olderAvg - 2) { wpmTrendEl.textContent = '↘️ Falling'; wpmTrendEl.className = 'stat-trend trend-down'; }
                    else { wpmTrendEl.textContent = '➡️ Stable'; wpmTrendEl.className = 'stat-trend trend-neutral'; }
                } else { wpmTrendEl.textContent = '--'; wpmTrendEl.className = 'stat-trend trend-neutral'; }

                // Accuracy Trend
                if (this.currentAccuracy >= 98) { accuracyTrendEl.textContent = '🎯 Perfect!'; accuracyTrendEl.className = 'stat-trend trend-up'; }
                else if (this.currentAccuracy >= 95) { accuracyTrendEl.textContent = '✅ Great!'; accuracyTrendEl.className = 'stat-trend trend-up'; }
                else if (this.currentAccuracy >= 90) { accuracyTrendEl.textContent = '⚠️ Good'; accuracyTrendEl.className = 'stat-trend trend-neutral'; }
                else { accuracyTrendEl.textContent = '❌ Needs Focus'; accuracyTrendEl.className = 'stat-trend trend-down'; }

                // Error Trend
                if (this.errors === 0) { errorTrendEl.textContent = '✨ Clean!'; errorTrendEl.className = 'stat-trend trend-up'; }
                else if (this.errors <= 2) { errorTrendEl.textContent = '✅ Low'; errorTrendEl.className = 'stat-trend trend-neutral'; }
                else { errorTrendEl.textContent = '🚨 High'; errorTrendEl.className = 'stat-trend trend-down'; }

                // Time Trend
                if (this.isGameActive) {
                    if (this.timeLeft > 30 || this.gameMode === 'zen') { timeTrendEl.textContent = '🟢 Active'; timeTrendEl.className = 'stat-trend trend-up'; }
                    else if (this.timeLeft > 10) { timeTrendEl.textContent = '🟡 Mid-game'; timeTrendEl.className = 'stat-trend trend-neutral'; }
                    else { timeTrendEl.textContent = '🔴 Final Seconds'; timeTrendEl.className = 'stat-trend trend-down'; }
                } else { timeTrendEl.textContent = '⏸️ Ready'; timeTrendEl.className = 'stat-trend trend-neutral'; }

                // Best WPM Trend
                bestTrendEl.textContent = this.currentWpm > this.bestOverallWpm ? '🎉 New Record!' : 'Keep Pushing!';
                bestTrendEl.className = this.currentWpm > this.bestOverallWpm ? 'stat-trend trend-up' : 'stat-trend trend-neutral';

                // Avg WPM Trend (simplified for now)
                avgTrendEl.textContent = 'Improving'; // Placeholder, actual logic would compare current avg to historical
                avgTrendEl.className = 'stat-trend trend-up';

                // Rhythm Trend
                if (this.rhythm > 4) { rhythmTrendEl.textContent = '⚡ Fast'; rhythmTrendEl.className = 'stat-trend trend-up'; }
                else if (this.rhythm > 2) { rhythmTrendEl.textContent = '➡️ Steady'; rhythmTrendEl.className = 'stat-trend trend-neutral'; }
                else { rhythmTrendEl.textContent = '🐢 Slow'; rhythmTrendEl.className = 'stat-trend trend-down'; }

                // Flow Trend
                if (this.flowState > 80) { flowTrendEl.textContent = '🌊 Deep Flow'; flowTrendEl.className = 'stat-trend trend-up'; }
                else if (this.flowState > 50) { flowTrendEl.textContent = '📈 Building'; flowTrendEl.className = 'stat-trend trend-neutral'; }
                else { flowTrendEl.textContent = '📉 Inactive'; flowTrendEl.className = 'stat-trend trend-down'; }
            }

            startGame() {
                this.isGameActive = true;
                this.startTime = Date.now();
                this.inputEl.placeholder = "Keep typing...";
                this.wpmHistory = [];
                this.accuracyHistory = [];
                this.keyPressTimings = [];
                this.peakWpm = 0;
                this.flowState = 0;
                this.consistency = 100;
                this.errors = 0; // Reset errors at start of game
                this.correctChars = 0;
                this.totalChars = 0;
                this.burstDetection.lastWpm = 0;
                this.burstDetection.lastBurstTime = 0;
                this.errorPatterns = {}; // Reset error patterns

                if (this.gameMode !== 'zen') {
                    this.timer = setInterval(() => {
                        if (!this.isPaused) {
                            this.timeLeft--;
                            this.timerEl.textContent = this.timeLeft;
                            
                            if (this.timeLeft <= 0) {
                                this.endGame();
                            }
                        }
                    }, 1000);
                }

                this.showNotification('🚀 Game Started', 'Good luck! Type with focus and precision.', 'success');
                this.playSound('success'); // Play a start sound
                this.inputEl.focus();
            }

            togglePause() {
                if (!this.isGameActive) return;

                this.isPaused = !this.isPaused;
                this.pauseBtn.textContent = this.isPaused ? '▶️ Resume' : '⏸️ Pause';
                this.inputEl.disabled = this.isPaused;

                if (this.isPaused) {
                    this.showNotification('⏸️ Game Paused', 'Take a break and resume when ready.', 'warning');
                    this.stopBackgroundMusic();
                } else {
                    this.showNotification('▶️ Game Resumed', 'Back to typing! Stay focused.', 'success');
                    this.startBackgroundMusic();
                    this.inputEl.focus();
                }
            }

            endGame() {
                this.isGameActive = false;
                this.isPaused = false;
                clearInterval(this.timer);
                this.inputEl.disabled = true;
                this.stopBackgroundMusic();
                
                // Update overall stats
                this.totalTestsCompleted++;
                this.totalWordsTyped += Math.round(this.currentSentence.length / 5); // Add remaining words
                if (this.currentWpm > this.bestOverallWpm) {
                    this.bestOverallWpm = this.currentWpm;
                    this.newRecordMessageEl.textContent = `🎉 New Personal Best: ${this.currentWpm} WPM!`;
                } else {
                    this.newRecordMessageEl.textContent = '';
                }

                // Update average WPM
                const allWpms = this.wpmHistory.map(p => p.wpm);
                if (allWpms.length > 0) {
                    this.avgOverallWpm = Math.round(allWpms.reduce((sum, w) => sum + w, 0) / allWpms.length);
                }

                // For consistency achievement
                this.wpmHistoryForConsistency.push(this.currentWpm);
                if (this.wpmHistoryForConsistency.length > 5) {
                    this.wpmHistoryForConsistency.shift();
                }

                // For error-free achievement
                if (this.errors === 0) {
                    this.errorFreeTests++;
                } else {
                    this.errorFreeTests = 0; // Reset if an error occurs
                }
                
                // Check achievements
                this.checkAchievements();
                
                // Save data
                this.saveUserData();
                
                // Show game over screen
                this.showGameOverScreen();
                
                this.playSound('success'); // Play an end sound
            }

            restartGame(showNotification = true) {
                // Reset all game state
                this.currentIndex = 0;
                this.startTime = null;
                this.timeLeft = this.gameMode === 'classic' ? 60 : this.gameMode === 'marathon' ? 300 : Infinity;
                this.isGameActive = false;
                this.isPaused = false;
                this.correctChars = 0;
                this.totalChars = 0;
                this.errors = 0;
                this.currentWpm = 0;
                this.currentAccuracy = 100;
                this.wpmHistory = [];
                this.accuracyHistory = [];
                this.keyPressTimings = [];
                this.peakWpm = 0;
                this.flowState = 0;
                this.consistency = 100;
                this.rhythm = 0;
                this.burstDetection.lastWpm = 0;
                this.burstDetection.lastBurstTime = 0;
                this.errorPatterns = {};
                this.aiProgress = { ai1: 0, ai2: 0, ai3: 0 };
                this.aiCurrentWpm = { ai1: 0, ai2: 0, ai3: 0 };
                
                // Clear timer
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                // Reset UI
                this.inputEl.disabled = false;
                this.inputEl.value = '';
                this.inputEl.placeholder = "Start typing to begin the ultimate test...";
                this.timerEl.textContent = this.timeLeft === Infinity ? '∞' : this.timeLeft;
                this.timerEl.parentElement.classList.remove('warning', 'critical');
                this.pauseBtn.textContent = '⏸️ Pause';
                this.gameOverEl.classList.remove('show');
                this.progressFill.style.width = '0%';
                this.flowFill.style.height = '0%';
                this.burstIndicator.classList.remove('show', 'fast', 'slow');
                
                // Clear chart
                this.clearChart();
                
                // Load new sentence and update displays
                this.loadNewSentence();
                this.updateAllDisplays();
                this.updateKeyboardHeatmap(); // Clear heatmap
                this.updateErrorAnalysis(); // Clear error analysis
                this.updateLeaderboard(); // Update leaderboard with latest personal bests
                
                // Focus input
                this.inputEl.focus();
                
                if (showNotification) {
                    this.showNotification('🔄 Game Restarted', 'Fresh start! Show us what you can do.', 'success');
                }
            }

            checkAchievements() {
                const newAchievements = [];
                const currentHour = new Date().getHours();

                Object.keys(this.achievements).forEach(key => {
                    const achievement = this.achievements[key];
                    if (achievement.unlocked) return;

                    let progress = achievement.progress;
                    let shouldUnlock = false;

                    switch(key) {
                        case 'first-test':
                            progress = this.totalTestsCompleted;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'speed-demon':
                            progress = this.currentWpm;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'lightning-fingers':
                            progress = this.currentWpm;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'accuracy-master':
                            progress = this.currentAccuracy;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'perfectionist':
                            progress = this.currentAccuracy;
                            shouldUnlock = progress === 100;
                            break;
                        case 'error-free':
                            progress = this.errorFreeTests;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'marathon-runner':
                            if (this.gameMode === 'marathon') {
                                progress = 1; // Just needs to complete one marathon
                                shouldUnlock = true;
                            }
                            break;
                        case 'consistency-king':
                            if (this.wpmHistoryForConsistency.length === 5) {
                                const avg = this.wpmHistoryForConsistency.reduce((sum, w) => sum + w, 0) / 5;
                                const maxDiff = Math.max(...this.wpmHistoryForConsistency.map(w => Math.abs(w - avg)));
                                if (maxDiff <= 5) { // Within +/- 5 WPM variance
                                    progress = 5;
                                    shouldUnlock = true;
                                }
                            }
                            break;
                        case 'streak-master':
                            progress = this.streak;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'flow-state':
                            progress = this.flowState;
                            shouldUnlock = progress >= achievement.target;
                            break;
                        case 'night-owl':
                            if (currentHour >= 0 && currentHour < 6) {
                                progress++;
                                shouldUnlock = progress >= achievement.target;
                            }
                            break;
                        case 'early-bird':
                            if (currentHour >= 5 && currentHour < 7) {
                                progress++;
                                shouldUnlock = progress >= achievement.target;
                            }
                            break;
                    }

                    achievement.progress = progress;
                    if (shouldUnlock) {
                        achievement.unlocked = true;
                        newAchievements.push(key);
                        this.showNotification('🏆 Achievement Unlocked!', `${achievement.name}: ${achievement.description}`, 'achievement');
                    }
                });

                this.updateAchievementsDisplay();
                return newAchievements;
            }

            updateAchievementsDisplay(filterCategory = 'all') {
                const achievementGrid = document.getElementById('achievementGrid');
                achievementGrid.innerHTML = ''; // Clear current grid

                let unlockedCount = 0;
                const totalAchievements = Object.keys(this.achievements).length;

                Object.keys(this.achievements).forEach(key => {
                    const achievement = this.achievements[key];
                    if (achievement.unlocked) {
                        unlockedCount++;
                    }

                    if (filterCategory === 'all' || achievement.category === filterCategory) {
                        const element = document.createElement('div');
                        element.classList.add('achievement');
                        if (achievement.unlocked) {
                            element.classList.add('unlocked');
                        }
                        element.dataset.achievement = key;
                        element.innerHTML = `
                            <div class="achievement-icon">${achievement.icon || '⭐'}</div>
                            <div class="achievement-title">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.description}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-fill" style="width: ${Math.min(100, (achievement.progress / achievement.target) * 100)}%;"></div>
                            </div>
                        `;
                        achievementGrid.appendChild(element);
                    }
                });

                document.getElementById('unlockedCount').textContent = unlockedCount;
                document.getElementById('totalAchievements').textContent = totalAchievements;
            }

            filterAchievements(category) {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.category-btn[data-category="${category}"]`).classList.add('active');
                this.updateAchievementsDisplay(category);
            }

            updateStreak() {
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                
                if (this.lastPlayDate === today) {
                    // Already played today, keep streak
                    return;
                } else if (this.lastPlayDate === yesterday) {
                    // Played yesterday, increment streak
                    this.streak = (this.streak || 0) + 1;
                } else {
                    // Missed a day or first time playing, reset to 1
                    this.streak = 1;
                }
                
                this.lastPlayDate = today;
                this.streakCount.textContent = this.streak;
            }

            checkTimeBasedAchievements() {
                const currentHour = new Date().getHours();
                
                // Check night owl achievement
                if (currentHour >= 0 && currentHour < 6 && !this.achievements['night-owl'].unlocked) {
                    // Progress is handled in checkAchievements on game end
                }
                
                // Check early bird achievement
                if (currentHour >= 5 && currentHour < 7 && !this.achievements['early-bird'].unlocked) {
                    // Progress is handled in checkAchievements on game end
                }
            }

            updateKeyboardHeatmap(key) {
                const keyElement = document.querySelector(`#keyboardHeatmap .key[data-key="${key}"]`);
                if (keyElement) {
                    keyElement.classList.add('active');
                    setTimeout(() => {
                        keyElement.classList.remove('active');
                    }, 200);
                    
                    this.keyPressCount[key] = (this.keyPressCount[key] || 0) + 1;
                    this.updateKeyFrequency(key);
                    this.updateFingerHighlight(key);
                }
            }

            updateKeyFrequency(key) {
                const keyElement = document.querySelector(`#keyboardHeatmap .key[data-key="${key}"]`);
                if (keyElement && this.keyPressCount[key]) {
                    const maxPresses = Math.max(...Object.values(this.keyPressCount));
                    const frequencyRatio = this.keyPressCount[key] / maxPresses;
                    
                    // Apply different levels of 'frequent' class based on ratio
                    keyElement.classList.remove('frequent-low', 'frequent-medium', 'frequent-high');
                    if (frequencyRatio > 0.7) {
                        keyElement.classList.add('frequent', 'frequent-high');
                    } else if (frequencyRatio > 0.4) {
                        keyElement.classList.add('frequent', 'frequent-medium');
                    } else if (frequencyRatio > 0.1) {
                        keyElement.classList.add('frequent', 'frequent-low');
                    }
                }
            }

            updateFingerHighlight(key) {
                const keyElement = document.querySelector(`#keyboardHeatmap .key[data-key="${key}"]`);
                if (keyElement) {
                    const finger = keyElement.dataset.finger;
                    if (finger) {
                        // Remove active from all fingers first
                        document.querySelectorAll('.finger-color').forEach(f => f.classList.remove('active'));
                        
                        const fingerElement = document.querySelector(`.finger-color .${finger}`);
                        if (fingerElement) {
                            fingerElement.parentElement.classList.add('active');
                        }
                    }
                }
            }

            updateKeyboardStats() {
                const hottestKeyEl = document.getElementById('hottestKey');
                const coldestKeyEl = document.getElementById('coldestKey');
                const keySpeedEl = document.getElementById('keySpeed');

                if (Object.keys(this.keyPressCount).length === 0) {
                    // hottestKeyEl.textContent = 'None';
                    // coldestKeyEl.textContent = 'None';
                    // keySpeedEl.textContent = '0';
                    return;
                }

                const sortedKeys = Object.entries(this.keyPressCount)
                    .sort(([,a], [,b]) => b - a);

                // hottestKeyEl.textContent = `${sortedKeys[0][0].toUpperCase()} (${sortedKeys[0][1]})`;
                // coldestKeyEl.textContent = `${sortedKeys[sortedKeys.length - 1][0].toUpperCase()} (${sortedKeys[sortedKeys.length - 1][1]})`;
                // keySpeedEl.textContent = this.rhythm.toFixed(1); // Reusing rhythm for key speed
            }

            updateLiveChart() {
                const chartWidth = 500; // SVG viewBox width
                const chartHeight = 180; // SVG viewBox height
                const paddingX = 20; // Padding on left/right
                const paddingY = 20; // Padding on top/bottom

                const effectiveWidth = chartWidth - 2 * paddingX;
                const effectiveHeight = chartHeight - 2 * paddingY;

                if (this.wpmHistory.length < 2) {
                    this.wpm
